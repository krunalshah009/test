{
	"AWSTemplateFormatVersion" : "2010-09-09",

	"Description" : "IAM groups and account-wide role configurations",

	"Parameters" : {
	   "CustomerPrefix" : {
            "Type" : "String",
            "Default" : "testcust",
            "Description" : "Enter Customer Prefix"
        },

	   "Environment"    : {
            "Type" : "String",
            "Default" : "dt",
            "Description" : "Enter Environment (Input Format - d=development, t=test, a=acceptance, p=production, dt=devtest, ap=acceptanceproduction)",
            "AllowedValues" : [
                "d",
                "t",
                "a",
                "p",
                "dt",
                "ap"
            ]
        },
	
		"CFNRole" : {
			"Type"				    : "String",
			"Default"			    : "true",
			"Description"			: "Whether a role should be created for use with Aws Jenkins Service",
			"AllowedValues"			: ["true", "false"],
			"ConstraintDescription"	: "Must be true or false."
		},

		
		"CFNAdminUser" : { 
		"Type"				    : "String",
		"Default"			    : "sogetiadmin",
		"Description"			: "Please provide IAM user name for group administrator"	
		},
		
		"CFNSysAdminUser" : { 
		"Type"				    : "String",
		"Default"			    : "sogetideveloper",
		"Description"			: "Please provide IAM user name for group systemadministrator"		
		},
		
		"CFNDBAUser" : { 
		"Type"				    : "String",
		"Default"			    : "sogetidba",
		"Description"			: "Please provide IAM user name for group databaseadministrator"		
		},
		
		"CFNReadOnlyUser" : { 
		"Type"				    : "String",
		"Default"			    : "sogetireaduser",
		"Description"			: "Please provide IAM user name for group read only"		
		},
		
		"CFNRoleName" : { 
		"Type"				    : "String",
		"Default"			    : "Jenkins_Tool_Access",
		"Description"			: "Please provide IAM role name used for jenkins server"		
		},
		
		"CFNAdminUserGroup" : { 
		"Type"				    : "String",
		"Default"			    : "Administrator",
		"Description"			: "Please provide IAM group name this user has full access and can delegate permissions to every service and resource in AWS"		
		},
		
		"CFNSysAdminUserGroup" : { 
		"Type"				    : "String",
		"Default"			    : "SystemAdministrator",
		"Description"			: "Please provide IAM group name this user sets up and maintains resources for development operations"		
		},
		
		"CFNDBAUserGroup" : { 
		"Type"				    : "String",
		"Default"			    : "DBA",
		"Description"			: "Please provide IAM group name this user sets up, configures, and maintains databases in the AWS Cloud"		
		},
		
		"CFNReadOnlyUserGroup" : { 
		"Type"				    : "String",
		"Default"			    : "Read-Only",
		"Description"			: "Please provide IAM group name this user Provides read-only access to AWS services and resources"		
		}
		
		
		
	},
	

	"Conditions" :{
		"IsDev" : {
			"Fn::Equals" : [ { "Ref" : "Environment" }, "d" ]
		},
		"IsTest" : {
			"Fn::Equals" : [ { "Ref" : "Environment" }, "t" ]
		},
		"IsAt" : {
			"Fn::Equals" : [ { "Ref" : "Environment" }, "a" ]
		},
		"IsPrd" : {
			"Fn::Equals" : [ { "Ref" : "Environment" }, "p" ]
		},
		
		"IsDt" : {
			"Fn::Equals" : [ { "Ref" : "Environment" }, "dt" ]
		},
		
		"IsAp" : {
			"Fn::Equals" : [ { "Ref" : "Environment" }, "ap" ]
		},
		
		
		
		"CFNRole" : {
			"Fn::Equals" : [ { "Ref" : "CFNRole" }, "true" ]
		}
		
	},

	"Resources" : {

		   "AdminUser" : {
			"Type" : "AWS::IAM::User",
			"Properties" : {
			"UserName" : { "Ref" : "CFNAdminUser" } 
			}
         },		
		 
		 
		 "SysAdminUser" : {
			"Type" : "AWS::IAM::User",
			"Properties" : {
			"UserName" : { "Ref" : "CFNSysAdminUser" }
			}
         },

          "DBAUser" : {
			"Type" : "AWS::IAM::User",
			"Properties" : {
			"UserName" : { "Ref" : "CFNDBAUser" }
			}
         },	

		  "ReadOnlyUser" : {
			"Type" : "AWS::IAM::User",
			"Properties" : {
			"UserName" : { "Ref" : "CFNReadOnlyUser" }
			}
         },		 

		 
			"AWSJenkinsServiceRole" : {
			"Type": "AWS::IAM::Role",
			"Condition" : "CFNRole",
			"DependsOn" : "AdminUser",
			"Properties" : {
				"RoleName": { "Ref" : "CFNRoleName" },
				"AssumeRolePolicyDocument": {
					"Statement": [
				{
				"Sid": "",
				"Effect": "Allow",
				"Principal": {
				"Service": "cloudformation.amazonaws.com"
			    },
				"Action": "sts:AssumeRole"
			 },
            {
             "Sid": "",
             "Effect": "Allow",
             "Principal": {
             "AWS": { "Fn::Join" : [ "/", [ "arn:aws:iam::684821578293:user", { "Ref" : "CFNAdminUser" } ]]},
             "Service": "cloudformation.amazonaws.com"
            },
           
		   "Action": "sts:AssumeRole"
           }]
		  },
		  "ManagedPolicyArns": 
                    [
                        "arn:aws:iam::aws:policy/AdministratorAccess"
                    ]
		  
     	}
	},
	
		    "CFNAdminUserAccessKey" : {
			"Type" : "AWS::IAM::AccessKey",
			"Properties" : {
			"UserName" : { "Ref" : "AdminUser" }
			}
		},
		
		    "CFNSysAdminUserAccessKey" : {
			"Type" : "AWS::IAM::AccessKey",
			"Properties" : {
			"UserName" : { "Ref" : "SysAdminUser" }
			}
		},
		
		    "CFNDBAUserAccessKey" : {
			"Type" : "AWS::IAM::AccessKey",
			"Properties" : {
			"UserName" : { "Ref" : "DBAUser" }
			}
		},

		    "CFNReadOnlyUserAccessKey" : {
			"Type" : "AWS::IAM::AccessKey",
			"Properties" : {
			"UserName" : { "Ref" : "ReadOnlyUser" }
			}
		},
		
			"CFNAdminAccountsGroup" : {
			"Type": "AWS::IAM::Group",
			"Properties" : {
			"GroupName" : { "Ref" : "CFNAdminUserGroup" },
			"ManagedPolicyArns": 
                    [
                        "arn:aws:iam::aws:policy/AdministratorAccess"
                    ]
            			
		}
       
	   },
	    
	        "CFNSysAdminAccountsGroup" : {
			"Type": "AWS::IAM::Group",
			"Properties" : {
			"GroupName" : { "Ref" : "CFNSysAdminUserGroup" },
			"ManagedPolicyArns": 
                    [
                        "arn:aws:iam::aws:policy/job-function/SystemAdministrator"
                    ]
            			
		}
       
	   },
	        "CFNDBAAccountsGroup" : {
			"Type": "AWS::IAM::Group",
			"Properties" : {
			"GroupName" : { "Ref" : "CFNDBAUserGroup" },
			"ManagedPolicyArns": 
                    [
                        "arn:aws:iam::aws:policy/job-function/DatabaseAdministrator"
                    ]
            			
		}
       
	   }, 
	   
	        "CFNReadOnlyAccountsGroup" : {
			"Type": "AWS::IAM::Group",
			"Properties" : {
			"GroupName" : { "Ref" : "CFNReadOnlyUserGroup" },
			"ManagedPolicyArns": 
                    [
                        "arn:aws:iam::aws:policy/ReadOnlyAccess"
                    ]
            			
		}
       
	   },
	   
	   
	     "CFNUserToGroupAdditionAdminUserToGroupAddition" : { 
	     "Type": "AWS::IAM::UserToGroupAddition",
	     "Properties" : {
	     "GroupName" : { "Ref" : "CFNAdminAccountsGroup" },
	     "Users" : [ { "Ref" : "CFNAdminUser" } ]
		 
	  }
	  
	 },
	 
	 "CFNGroupToUserAdditionAdminUserToGroupAddition" : { 
	   "Type": "AWS::IAM::UserToGroupAddition",
	   "Properties" : {
	     "Users" : [ { "Ref" : "CFNAdminUser" } ],
		 "GroupName" : { "Ref" : "CFNAdminAccountsGroup" }
	     
		 
	  }
	  
	 },
	 
	 "CFNUserToGroupAdditionSysAdminUserToGroupAddition" : { 
	   "Type": "AWS::IAM::UserToGroupAddition",
	   "Properties" : {
	     "GroupName" : { "Ref" : "CFNSysAdminAccountsGroup" },
	     "Users" : [ { "Ref" : "CFNSysAdminUser" } ]
		 
	  }
	  
	 },
	 
	 "CFNGroupToUserAdditionsysAdminUserToGroupAddition" : { 
	   "Type": "AWS::IAM::UserToGroupAddition",
	   "Properties" : {
	     "Users" : [ { "Ref" : "CFNSysAdminUser" } ],
		 "GroupName" : { "Ref" : "CFNSysAdminAccountsGroup" }
	     
		 
	  }
	  
	 },
	 
	     "CFNUserToGroupAdditionDBAUserToGroupAddition" : { 
	     "Type": "AWS::IAM::UserToGroupAddition",
	     "Properties" : {
	     "GroupName" : { "Ref" : "CFNDBAAccountsGroup" },
	     "Users" : [ { "Ref" : "CFNDBAUser" } ]
		 
	  }
	  
	 },
	 
	    "CFNGroupToUserAdditionDBAUserToGroupAddition" : { 
	    "Type": "AWS::IAM::UserToGroupAddition",
	    "Properties" : {
	    "Users" : [ { "Ref" : "CFNDBAUser" } ],
		"GroupName" : { "Ref" : "CFNDBAAccountsGroup" }
	     
	  }
	 
	 },
	 
	 "CFNUserToGroupAdditionReadOnlyUserToGroupAddition" : { 
	     "Type": "AWS::IAM::UserToGroupAddition",
	     "Properties" : {
	     "GroupName" : { "Ref" : "CFNReadOnlyAccountsGroup" },
	     "Users" : [ { "Ref" : "CFNReadOnlyUser" } ]
		 
	  }
	  
	 },
	 
	 "CFNGroupToUserAdditionReadOnlyUserToGroupAddition" : { 
	   "Type": "AWS::IAM::UserToGroupAddition",
	   "Properties" : {
	     "Users" : [ { "Ref" : "CFNReadOnlyUser" } ],
		 "GroupName" : { "Ref" : "CFNReadOnlyAccountsGroup" }
	     
		 
	  }
	  
	 }
	 
	 
	},

		"Outputs" : {
		
		"CFNAdminUserAccessKey" : {
			"Description" 	: "The access key for the CFN Group Admin",
			"Value"		: { "Ref" : "CFNAdminUserAccessKey" }
		},

		"CFNAdminUserSecret" : {
			"Description" 	: "The secret key for the CFN Group Adminstrator",
			"Value"		: { "Fn::GetAtt" : [ "CFNAdminUserAccessKey", "SecretAccessKey" ] }
		},
		
		"CFNSysAdminUserAccessKey" : {
			"Description" 	: "The access key for the CFN Group SystemAdministrator",
			"Value"		: { "Ref" : "CFNSysAdminUserAccessKey" }
		},

		"CFNSysAdminUserSecret" : {
			"Description" 	: "The secret key for the CFN Group associated with SystemAdministrator  ",
			"Value"		: { "Fn::GetAtt" : [ "CFNSysAdminUserAccessKey", "SecretAccessKey" ] }
		},
		
		"CFNDBAUserAccessKey" : {
			"Description" 	: "The access key for the CFN Group associated with DatabaseAdministrator",
			"Value"		: { "Ref" : "CFNDBAUserAccessKey" }
		},
		
		"CFNDBAUserSecret" : {
			"Description" 	: "The secret key for the CFN Group associated with DatabaseAdministrator",
			"Value"		: { "Fn::GetAtt" : [ "CFNDBAUserAccessKey", "SecretAccessKey" ] }
		},
		
		"CFNReadOnlyUserAccessKey" : {
			"Description" 	: "The access key for the CFN Group associated with  Read-Only",
			"Value"		: { "Ref" : "CFNReadOnlyUserAccessKey" }
		},
		
		"CFNReadOnlyUserSecret" : {
			"Description" 	: "The secret key for the CFN Group associated with Read-Only",
			"Value"		: { "Fn::GetAtt" : [ "CFNReadOnlyUserAccessKey", "SecretAccessKey" ] }
		}
		
		
	}
}
